---
layout: post
title:  "Modelo de escrita CTE"
date:   2023-07-17 18:42:47 -0300
categories: SQL
thumbnail: "https://static.wixstatic.com/media/710ee0_e15873799f2e40c0976ddeb3d507c8e3~mv2.jpg/v1/fill/w_2187,h_1640,al_c,q_90/710ee0_e15873799f2e40c0976ddeb3d507c8e3~mv2.webp"
excerpt: " "
---

# Como ele pode melhorar suas consultas

O SQL (Structured Query Language) √© uma linguagem de programa√ß√£o usada para gerenciar e manipular bancos de dados.

Uma das caracter√≠sticas mais poderosas do SQL √© a capacidade de escrever consultas complexas para extrair informa√ß√µes valiosas dos dados.

<p align="center">
  <img src="https://static.wixstatic.com/media/710ee0_e15873799f2e40c0976ddeb3d507c8e3~mv2.jpg/v1/fill/w_2187,h_1640,al_c,q_90/710ee0_e15873799f2e40c0976ddeb3d507c8e3~mv2.webg" width="500" height="300">
</p>

Uma dessas t√©cnicas avan√ßadas √© o uso de Express√µes de Tabela Comum, ou `CTEs (Common Table Expressions)`.

As CTEs s√£o uma forma de criar consultas tempor√°rias que s√£o usadas dentro de uma instru√ß√£o SQL maior.

Elas s√£o √∫teis para simplificar consultas complexas, dividindo-as em partes menores e mais gerenci√°veis. Neste post, vamos explorar o que s√£o CTEs, como us√°-las e como elas podem melhorar suas consultas SQL.

## O que √© uma CTE?

Uma CTE √© uma express√£o de tabela nomeada tempor√°ria que voc√™ pode referenciar dentro de uma instru√ß√£o `SELECT`, `INSERT`, `UPDATE`, `DELETE` ou outra `CTE`.

Ela √© usada para simplificar consultas SQL complexas, dividindo-as em partes menores e mais gerenci√°veis. A CTE √© definida usando a cl√°usula `WITH` antes da consulta SQL e pode ser pensada como uma vis√£o tempor√°ria que existe apenas durante a execu√ß√£o da consulta.

### Aqui est√° um exemplo b√°sico de uma CTE:

```sql
WITH Sales_CTE (SalesPersonID, NumberOfOrders)
AS
(
SELECT 
    SalesPersonID
    , COUNT(OrderID)
FROM SalesOrderHeader
GROUP BY SalesPersonID
)

SELECT 
    SalesPersonID
    , NumberOfOrders
FROM Sales_CTE;
```

Neste exemplo, a CTE Sales_CTE agrupa as vendas por SalesPersonID. A consulta principal ent√£o seleciona os dados da CTE.

## Como as CTEs podem melhorar suas consultas SQL?

As CTEs podem melhorar suas consultas SQL de v√°rias maneiras:

1. Simplifica√ß√£o de consultas complexas: 

As CTEs permitem que voc√™ divida consultas complexas em partes menores e mais gerenci√°veis. Isso torna o c√≥digo mais f√°cil de entender e manter.
    
2. Reutiliza√ß√£o de c√≥digo: 

As CTEs podem ser referenciadas v√°rias vezes na mesma consulta, o que evita a necessidade de repetir o mesmo c√≥digo.
    
3. Recursividade: 

As CTEs permitem consultas recursivas, o que √© √∫til para trabalhar com dados hier√°rquicos.
    
4. Melhor desempenho: 

Em alguns casos, o uso de CTEs pode resultar em um desempenho melhorado em compara√ß√£o com subconsultas ou joins complexos.

## Exemplos pr√°ticos de CTEs

Vamos ver alguns exemplos de como as CTEs podem ser usadas para melhorar suas consultas SQL.

### Simplificando consultas complexas

Suponha que voc√™ tenha uma consulta que envolva v√°rias jun√ß√µes e agrega√ß√µes. Sem CTEs, sua consulta pode parecer algo assim:

```sql
SELECT 
    SalesPersonID
    , COUNT(OrderID)
FROM SalesOrderHeader
WHERE SalesPersonID IN

(
SELECT 
    SalesPersonID
FROM SalesPerson
WHERE TerritoryID IN
(
SELECT 
    TerritoryID
FROM SalesTerritory
WHERE [Group] = 'North America'
)
)
GROUP BY SalesPersonID;
```

Com CTEs, voc√™ pode dividir essa consulta complexa em partes menores:

```sql
WITH NorthAmericanTerritories AS
(
SELECT 
    TerritoryID
FROM SalesTerritory
WHERE [Group] = 'North America'

), NorthAmericanSalesPeople AS

(
SELECT 
    SalesPersonID
FROM SalesPerson
WHERE TerritoryID IN (
                        SELECT 
                            TerritoryID 
                        FROM NorthAmericanTerritories
                    )
)

SELECT 
    SalesPersonID
    , COUNT(OrderID)
FROM SalesOrderHeader
WHERE SalesPersonID IN (
                        SELECT 
                            SalesPersonID 
                        FROM NorthAmericanSalesPeople
                        )
GROUP BY SalesPersonID;
```

## Consultas recursivas

As CTEs tamb√©m podem ser usadas para consultas recursivas. Por exemplo, suponha que voc√™ tenha uma tabela Employees com uma rela√ß√£o hier√°rquica de gerente-empregado. Voc√™ pode usar uma CTE recursiva para obter todos os subordinados diretos e indiretos de um gerente:

```sql
WITH EmployeeHierarchy AS
(
SELECT 
    EmployeeID
    , FirstName
    , LastName
    , ManagerID
FROM Employees
WHERE ManagerID IS NULL

UNION ALL

SELECT 
    E.EmployeeID
    , E.FirstName
    , E.LastName
    , E.ManagerID
FROM Employees E
INNER JOIN EmployeeHierarchy EH ON E.ManagerID = EH.EmployeeID
)
SELECT 
    *
FROM EmployeeHierarchy;
```

Em resumo, as CTEs s√£o uma ferramenta poderosa que pode melhorar a legibilidade, a manuten√ß√£o e o desempenho de suas consultas SQL. Se voc√™ ainda n√£o est√° usando CTEs em suas consultas SQL, eu recomendo que voc√™ comece a explor√°-las.

[Linhares015 - üßô‚Äç‚ôÇÔ∏è](https://github.com/Linhares015)